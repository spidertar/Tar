<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø±ØµØ¯ Ù¾Ù‡Ù¾Ø§Ø¯ÛŒ ØªØ§Ø± - TAR C4ISR</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.34/"></script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    html, body {
      padding: 0; 
      margin: 0; 
      height: 100vh; 
      width: 100vw;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      direction: rtl;
      overflow: hidden;
      background: #1a1a1a;
    }

    #viewDiv {
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 120px;
      z-index: 1;
    }

    /* Header */
    .tar-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .tar-logo {
      display: flex;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .tar-logo::before {
      content: "ğŸ•¸ï¸";
      margin-left: 8px;
      font-size: 20px;
    }

    .threat-level {
      background: #ff4444;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    /* Bottom Control Panel */
    .control-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 120px;
      background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
      z-index: 1000;
      border-top: 2px solid #3498db;
    }

    .control-tabs {
      display: flex;
      height: 30px;
      background: #1a252f;
    }

    .control-tab {
      flex: 1;
      background: #2c3e50;
      color: white;
      border: none;
      padding: 10px 5px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      border-right: 1px solid #34495e;
      transition: all 0.3s;
    }

    .control-tab.active {
      background: #3498db;
      color: white;
    }

    .control-tab:hover {
      background: #34495e;
    }

    .control-content {
      height: 130px;
      overflow-y: auto;
      padding: 10px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Military Action Buttons */
    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      height: 100%;
    }

    .action-btn {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px;
      font-size: 10px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }

    .action-btn.intercept {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .action-btn.destroy {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .action-btn.jam {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
    }

    .action-btn.track {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    }

    /* Statistics Panel */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      height: 100%;
    }

    .stat-item {
      background: rgba(52, 73, 94, 0.8);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      color: white;
    }

    .stat-number {
      font-size: 16px;
      font-weight: bold;
      color: #3498db;
    }

    .stat-label {
      font-size: 10px;
      margin-top: 2px;
    }

    /* Command Panel */
    .command-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      height: 100%;
    }

    .command-btn {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      border: 2px solid #3498db;
      border-radius: 8px;
      padding: 8px;
      font-size: 10px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .command-btn:hover {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      border-color: white;
    }

    /* Alert System */
    .alert-system {
      position: fixed;
      top: 70px;
      right: 10px;
      width: 200px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 999;
    }

    .alert-item {
      background: rgba(231, 76, 60, 0.9);
      color: white;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 5px;
      font-size: 11px;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .tar-logo {
        font-size: 14px;
      }
      
      .control-tab {
        font-size: 10px;
        padding: 8px 3px;
      }
      
      .action-btn {
        font-size: 9px;
        padding: 6px;
      }
      
      .stat-number {
        font-size: 14px;
      }
      
      .stat-label {
        font-size: 9px;
      }
    }

    /* Popup styling */
    .esri-popup__content {
      font-size: 10px; 
      line-height: 1.4; 
      text-align: right;
      direction: rtl;
    }

    .flightradar-link {
      color: #3498db; 
      text-decoration: underline; 
      cursor: pointer;
    }

    /* Demo warning */
    .demo-warning {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: #ff6b6b;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 10000;
      border: 2px solid #ff6b6b;
      display: none;
    }

    .demo-warning.show {
      display: block;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="tar-header">
    <div class="tar-logo">Ø³Ø§Ù…Ø§Ù†Ù‡ ØªØ§Ø± - TAR C4ISR</div>
    <div class="threat-level" id="threatLevel">Ø³Ø·Ø­ ØªÙ‡Ø¯ÛŒØ¯: Ù…ØªÙˆØ³Ø·</div>
  </div>

  <!-- Map View -->
  <div id="viewDiv"></div>

  <!-- Alert System -->
  <div class="alert-system" id="alertSystem"></div>

  <!-- Control Panel -->
  <div class="control-panel">
    <div class="control-tabs">
      <button class="control-tab active" onclick="showTab('actions')">Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø¸Ø§Ù…ÛŒ</button>
      <button class="control-tab" onclick="showTab('stats')">Ø¢Ù…Ø§Ø±</button>
      <button class="control-tab" onclick="showTab('command')">ÙØ±Ù…Ø§Ù†Ø¯Ù‡ÛŒ</button>
      <button class="control-tab" onclick="showTab('intel')">Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
    </div>
    
    <div class="control-content">
      <!-- Military Actions Tab -->
      <div id="actions" class="tab-panel active">
        <div class="action-grid">
          <button class="action-btn intercept" onclick="militaryAction('intercept')">
            ğŸš Ø±Ù‡Ú¯ÛŒØ±ÛŒ
          </button>
          <button class="action-btn destroy" onclick="militaryAction('destroy')">
            <a href="https://google.com">      
            ğŸ’¥ Ø§Ù†Ù‡Ø¯Ø§Ù…
                </a>
          </button>
          <button class="action-btn jam" onclick="militaryAction('jam')">
            ğŸ“¡ ØªØ¯Ø§Ø®Ù„
          </button>
          <button class="action-btn track" onclick="militaryAction('track')">
            ğŸ¯ Ø±Ø¯ÛŒØ§Ø¨ÛŒ
          </button>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div id="stats" class="tab-panel">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number" id="droneCount">0</div>
            <div class="stat-label">Ù¾Ù‡Ù¾Ø§Ø¯</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="militaryCount">0</div>
            <div class="stat-label">Ù†Ø¸Ø§Ù…ÛŒ</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="civilianCount">0</div>
            <div class="stat-label">ØºÛŒØ±Ù†Ø¸Ø§Ù…ÛŒ</div>
          </div>
        </div>
      </div>

      <!-- Command Tab -->
      <div id="command" class="tab-panel">
        <div class="command-grid">
          <button class="command-btn" onclick="commandAction('alert')">
            ğŸš¨ Ø¢Ú˜ÛŒØ± Ø®Ø·Ø±
          </button>
          <button class="command-btn" onclick="commandAction('scramble')">
            âœˆï¸ Ø§Ø¹Ø²Ø§Ù… Ø¬Ù†Ú¯Ù†Ø¯Ù‡
          </button>
          <button class="command-btn" onclick="commandAction('defense')">
            ğŸ›¡ï¸ Ø¯ÙØ§Ø¹ Ù…Ù„ÛŒ
          </button>
          <button class="command-btn" onclick="commandAction('coordination')">
            ğŸ“ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ
          </button>
        </div>
      </div>

      <!-- Intelligence Tab -->
      <div id="intel" class="tab-panel">
        <div style="color: white; font-size: 11px; line-height: 1.4;">
          <div><strong>ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„ÛŒØ§ØªÛŒ:</strong> Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø§Ø´</div>
          <div><strong>Ù¾ÙˆØ´Ø´ Ø±Ø§Ø¯Ø§Ø±ÛŒ:</strong> Û±Û°Û°Ùª</div>
          <div><strong>Ø³ÛŒØ³ØªÙ… Ø¯ÙØ§Ø¹ÛŒ:</strong> ÙØ¹Ø§Ù„</div>
          <div><strong>Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª:</strong> Ø§Ù…Ù†</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Demo Warning Modal -->
  <div class="demo-warning" id="demoWarning">
    <h3>âš ï¸ Ø³ÛŒØ³ØªÙ… Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ âš ï¸</h3>
    <p>Ø§ÛŒÙ† Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø§Ø³Øª</p>
    <p>Ù‡ÛŒÚ† ØªØ¯Ø§Ø®Ù„ ÙÛŒØ²ÛŒÚ©ÛŒ Ø¯Ø± Ù¾Ø±ÙˆØ§Ø²Ù‡Ø§ ØµÙˆØ±Øª Ù†Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯</p>
    <button onclick="closeDemoWarning()" style="margin-top: 10px; padding: 5px 15px; background: #3498db; color: white; border: none; border-radius: 5px;">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/widgets/BasemapToggle"
    ], 
    
    function(Map, MapView, Graphic, GraphicsLayer, BasemapToggle) {
      const map = new Map({ basemap: "satellite" });
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [53, 30],
        zoom: 8
      });

      const basemapToggle = new BasemapToggle({
        view: view,
        nextBasemap: "streets-vector"
      });
      view.ui.add(basemapToggle, "top-left");

      const droneLayer = new GraphicsLayer();
      const militaryLayer = new GraphicsLayer();
      const civilianLayer = new GraphicsLayer();
      map.addMany([civilianLayer, militaryLayer, droneLayer]);

      let isFirstLoad = true;
      let selectedTarget = null;
      let alertCount = 0;

      // Tab switching function
      window.showTab = function(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.remove('active');
        });
        document.querySelectorAll('.control-tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
      };

      // Military action functions
      window.militaryAction = function(action) {
        showDemoWarning();
        
        const actions = {
          'intercept': 'Ø¹Ù…Ù„ÛŒØ§Øª Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ø´Ø±ÙˆØ¹ Ø´Ø¯',
          'destroy': 'Ø¯Ø³ØªÙˆØ± Ø§Ù†Ù‡Ø¯Ø§Ù… ØµØ§Ø¯Ø± Ø´Ø¯',
          'jam': 'Ø³ÛŒØ³ØªÙ… ØªØ¯Ø§Ø®Ù„ ÙØ¹Ø§Ù„ Ø´Ø¯',
          'track': 'Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ù‡Ø¯Ù Ø¢ØºØ§Ø² Ø´Ø¯'
        };

        addAlert(actions[action]);
        updateThreatLevel();
        
        // Simulate action feedback
        setTimeout(() => {
          addAlert(`Ø¹Ù…Ù„ÛŒØ§Øª ${actions[action]} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯`);
        }, 3000);
      };

      window.commandAction = function(action) {
        showDemoWarning();
        
        const commands = {
          'alert': 'Ø¢Ú˜ÛŒØ± Ø®Ø·Ø± ÙØ¹Ø§Ù„ Ø´Ø¯',
          'scramble': 'Ø¬Ù†Ú¯Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¹Ø²Ø§Ù…',
          'defense': 'Ø³ÛŒØ³ØªÙ… Ø¯ÙØ§Ø¹ Ù…Ù„ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯',
          'coordination': 'Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø±Ø§Ú©Ø² ÙØ±Ù…Ø§Ù†Ø¯Ù‡ÛŒ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯'
        };

        addAlert(commands[action]);
        updateThreatLevel();
      };

      function showDemoWarning() {
        document.getElementById('demoWarning').classList.add('show');
      }

      window.closeDemoWarning = function() {
        document.getElementById('demoWarning').classList.remove('show');
      };

      function addAlert(message) {
        const alertSystem = document.getElementById('alertSystem');
        const alertItem = document.createElement('div');
        alertItem.className = 'alert-item';
        alertItem.textContent = `${new Date().toLocaleTimeString('fa-IR')}: ${message}`;
        
        alertSystem.insertBefore(alertItem, alertSystem.firstChild);
        
        // Remove old alerts (keep only 5)
        if (alertSystem.children.length > 5) {
          alertSystem.removeChild(alertSystem.lastChild);
        }

        alertCount++;
      }

      function updateThreatLevel() {
        const threatLevel = document.getElementById('threatLevel');
        const levels = ['Ú©Ù…', 'Ù…ØªÙˆØ³Ø·', 'Ø¨Ø§Ù„Ø§', 'Ø¨Ø­Ø±Ø§Ù†ÛŒ'];
        const currentLevel = Math.min(Math.floor(alertCount / 2), 3);
        threatLevel.textContent = `Ø³Ø·Ø­ ØªÙ‡Ø¯ÛŒØ¯: ${levels[currentLevel]}`;
        
        const colors = ['#27ae60', '#f39c12', '#e67e22', '#e74c3c'];
        threatLevel.style.background = colors[currentLevel];
      }

      function updateStats() {
        document.getElementById('droneCount').textContent = droneLayer.graphics.length;
        document.getElementById('militaryCount').textContent = militaryLayer.graphics.length;
        document.getElementById('civilianCount').textContent = civilianLayer.graphics.length;
      }

      // Data fetching functions (same as original)
      async function fetchAdsbData() {
        try {
          const response = await fetch('/api/adsb/mil');
          const text = await response.text();
          const cleanedText = text.replace(/^while\(1\);/, '').trim();
          const data = JSON.parse(cleanedText);
          return Array.isArray(data) ? data : data.aircraft || data.ac || [];
        } catch (error) {
          return [];
        }
      }

      async function fetchFlightradarData() {
        try {
          const response = await fetch('/api/fr24');
          const text = await response.text();
          const cleanedText = text.replace(/^while\(1\);/, '').trim();
          const data = JSON.parse(cleanedText);
          const flights = [];
          for (const [key, value] of Object.entries(data)) {
            if (!Array.isArray(value)) continue;
            flights.push({
              id: key,
              lat: value[1],
              lon: value[2],
              track: value[3] || 0,
              alt_baro: value[4] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
              gs: value[5] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
              flight: value[13] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
              hex: value[0] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
              type: 'civilian',
              model: value[8] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
              r: value[9] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
              category: value[11] || 'Ù†Ø§Ù…Ø´Ø®Øµ'
            });
          }
          return flights;
        } catch (error) {
          return [];
        }
      }

      async function fetchOpenSkyData() {
        try {
          const response = await fetch('/api/opensky');
          const data = await response.json();
          return (data.states || []).map(flight => ({
            icao24: flight[0],
            callsign: flight[1]?.trim() || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            lon: flight[5],
            lat: flight[6],
            alt_baro: flight[7] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            velocity: flight[9] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            heading: flight[10] || 0,
            type: 'aircraft',
            hex: flight[0] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            squawk: flight[14] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            emergency: flight[15] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            baro_rate: flight[11] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            alt_geom: flight[13] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            nav_modes: flight[16] || [],
            nac_p: flight[17] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            nac_v: flight[18] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            sil: flight[19] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            sil_type: flight[20] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            gva: flight[21] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            sda: flight[22] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            alert: flight[23] || 'Ù†Ø§Ù…Ø´Ø®Øµ',
            spi: flight[24] || 'Ù†Ø§Ù…Ø´Ø®Øµ'
          }));
        } catch (error) {
          return [];
        }
      }
      
      function getSampleDroneData() {
        return [];
      }

      function identifyFlightType(flight) {
        if ((flight.gs < 100 || flight.velocity < 100) || flight.alt_baro < 5000 ||
            ['DJI', 'Mq', 'Bayraktar', 'Mavic','shahed'].some(model => flight.model?.includes(model) || flight.t?.includes(model))) {
          return 'drone';
        }
        if (!flight.callsign && !flight.flight || flight.callsign === 'Ù†Ø§Ù…Ø´Ø®Øµ' && flight.flight === 'Ù†Ø§Ù…Ø´Ø®Øµ') {
          return 'unknown';
        }
        if (flight.type === 'military' && ['Eurofighter', 'F-16', 'F-35', 'F-22', 'Su-27', 'MiG-29'].some(model => flight.t?.includes(model) || flight.model?.includes(model))) {
          return 'fighter';
        }
        if (flight.category?.includes('Naval') || flight.t?.includes('P-8') || flight.t?.includes('Poseidon')) {
          return 'navy';
        }
        if (flight.hex?.startsWith('7B') || flight.r?.startsWith('EP-')) {
          return 'iranian';
        }
        return flight.type === 'military' ? 'military' : 'civilian';
      }

      function getFlightColor(flight) {
        const flightType = identifyFlightType(flight);
        switch (flightType) {
          case 'drone': return 'black';
          case 'unknown': return 'yellow';
          case 'fighter': return 'orange';
          case 'navy': return 'lightblue';
          case 'iranian': return 'green';
          case 'military': return 'red';
          default: return 'blue';
        }
      }

      function getIconSize(zoom) {
        if (zoom >= 11) return "12px";
        if (zoom >= 8) return "20px";
        if (zoom >= 6) return "28px";
        if (zoom >= 3) return "36px";
        return "18px";
      }

      function createMilitaryPopupContent(flight) {
                 const flightradarLink = (flight.flight && flight.flight !== 'Ù†Ø§Ù…Ø´Ø®Øµ' && flight.hex) ? 
          `<a class="flightradar-link" href="https://www.flightradar24.com/${flight.flight}/${flight.hex}/3d" target="_blank">Ù†Ù…Ø§ÛŒØ´ Û³Ø¨Ø¹Ø¯ÛŒ Ù…Ø³ÛŒØ±</a>` : '';
        
        const actionButtons = `
          <div style="margin-top: 10px; direction: ltr;">
            <button onclick="window.parent.militaryAction('track')" style="background: #27ae60; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">Ø±Ø¯ÛŒØ§Ø¨ÛŒ</button>
            <button onclick="window.parent.militaryAction('intercept')" style="background: #f39c12; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">Ø±Ù‡Ú¯ÛŒØ±ÛŒ</button>
            <button onclick="window.parent.militaryAction('jam')" style="background: #9b59b6; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">ØªØ¯Ø§Ø®Ù„</button>
          </div>
        `;
        
        return `
          <b>Ù†ÙˆØ¹ Ù…Ù†Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡: </b>${flight.type || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø´Ù†Ø§Ø³Ù‡ Ù‡Ú¯Ø²Ø§: </b>${flight.hex || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±ÙˆØ§Ø²: </b>${flight.flight || flight.callsign || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø´Ù…Ø§Ø±Ù‡ Ø«Ø¨Øª: </b>${flight.r || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ù†ÙˆØ¹ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§: </b>${flight.t || flight.model || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø§Ø±ÙˆÙ…ØªØ±ÛŒÚ© (ÙÙˆØª): </b>${flight.alt_baro || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø§Ø±ØªÙØ§Ø¹ Ù‡Ù†Ø¯Ø³ÛŒ (ÙÙˆØª): </b>${flight.alt_geom || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø³Ø±Ø¹Øª Ø²Ù…ÛŒÙ†ÛŒ (Ú¯Ø±Ù‡): </b>${flight.gs || flight.velocity || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø¬Ù‡Øª Ø­Ø±Ú©Øª (Ø¯Ø±Ø¬Ù‡): </b>${flight.track || flight.heading || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ú©Ø¯ Ø§Ø³Ú©ÙˆØ§Ú©: </b>${flight.squawk || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>ÙˆØ¶Ø¹ÛŒØª Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ: </b>${flight.emergency || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: </b>${flight.lat || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: </b>${flight.lon || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          ${flightradarLink}
          ${actionButtons}
        `;
      }

      function createCivilianPopupContent(flight) {
        const flightradarLink = flight.hex && flight.flight !== 'Ù†Ø§Ù…Ø´Ø®Øµ' ? 
          `<a class="flightradar-link" href="https://www.flightradar24.com/${flight.flight}/${flight.hex}/3d" target="_blank">Ù†Ù…Ø§ÛŒØ´ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ Ùˆ Ù…Ø³ÛŒØ±</a>` : '';
        return `
          <b>Ù†ÙˆØ¹ Ù…Ù†Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡: </b>${flight.type || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø´Ù†Ø§Ø³Ù‡ Ù‡Ú¯Ø²Ø§: </b>${flight.hex || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±ÙˆØ§Ø²: </b>${flight.flight || flight.callsign || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø´Ù…Ø§Ø±Ù‡ Ø«Ø¨Øª: </b>${flight.r || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ù†ÙˆØ¹ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§: </b>${flight.model || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø§Ø±ÙˆÙ…ØªØ±ÛŒÚ© (ÙÙˆØª): </b>${flight.alt_baro || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø³Ø±Ø¹Øª Ø²Ù…ÛŒÙ†ÛŒ (Ú¯Ø±Ù‡): </b>${flight.gs || flight.velocity || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø¬Ù‡Øª Ø­Ø±Ú©Øª (Ø¯Ø±Ø¬Ù‡): </b>${flight.track || flight.heading || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: </b>${flight.lat || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: </b>${flight.lon || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          ${flightradarLink}
        `;
      }

      function createDronePopupContent(drone) {
        const actionButtons = `
          <div style="margin-top: 10px; direction: ltr;">
            <button onclick="window.parent.militaryAction('track')" style="background: #27ae60; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">Ø±Ø¯ÛŒØ§Ø¨ÛŒ</button>
            <button onclick="window.parent.militaryAction('intercept')" style="background: #f39c12; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">Ø±Ù‡Ú¯ÛŒØ±ÛŒ</button>
            <button onclick="window.parent.militaryAction('jam')" style="background: #9b59b6; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">ØªØ¯Ø§Ø®Ù„</button>
            <button onclick="window.parent.militaryAction('destroy')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; margin: 2px; border-radius: 3px; cursor: pointer;">Ø§Ù†Ù‡Ø¯Ø§Ù…</button>
          </div>
        `;
        
        return `
          <b>Ù†ÙˆØ¹ Ù…Ù†Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡: </b>${drone.type || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø´Ù†Ø§Ø³Ù‡ Ù¾Ù‡Ù¾Ø§Ø¯: </b>${drone.id || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ù…Ø¯Ù„: </b>${drone.model || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: </b>${drone.lat || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: </b>${drone.lon || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø§Ø±ÙˆÙ…ØªØ±ÛŒÚ© (ÙÙˆØª): </b>${drone.alt_baro || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø³Ø±Ø¹Øª Ø²Ù…ÛŒÙ†ÛŒ (Ú¯Ø±Ù‡): </b>${drone.velocity || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ø¬Ù‡Øª Ø­Ø±Ú©Øª (Ø¯Ø±Ø¬Ù‡): </b>${drone.heading || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
          <b>Ù†ÙˆØ¹: </b>Ù¾Ù‡Ù¾Ø§Ø¯<br>
          ${actionButtons}
        `;
      }

      async function updateMarkers() {
        const adsbFlights = await fetchAdsbData();
        const flightradarFlights = await fetchFlightradarData();
        const openSkyFlights = await fetchOpenSkyData();
        const droneData = getSampleDroneData();
        const allFlights = [...adsbFlights.map(f => ({ ...f, type: 'military' })), ...flightradarFlights, ...openSkyFlights, ...droneData];

        civilianLayer.removeAll();
        militaryLayer.removeAll();
        droneLayer.removeAll();

        const iconSize = getIconSize(view.zoom);

        allFlights.forEach(flight => {
          if (flight.lat && flight.lon) {
            const flightType = identifyFlightType(flight);
            const layer = flightType === 'drone' ? droneLayer : 
                         (flightType === 'military' || flightType === 'fighter' || flightType === 'navy' || flightType === 'iranian') ? militaryLayer : 
                         civilianLayer;

            const graphic = new Graphic({
              geometry: {
                type: "point",
                latitude: flight.lat,
                longitude: flight.lon
              },
              symbol: {
                type: "picture-marker",
                url: flightType === 'drone' ? "https://img.icons8.com/ios/40/drone-bottom-view.png" :
                     flightType === 'unknown' ? "https://www.iconsdb.com/icons/preview/yellow/airplane-3-xl.png" :
                     flightType === 'fighter' ? "https://www.iconsdb.com/icons/preview/orange/airplane-3-xl.png" :
                     flightType === 'navy' ? "https://www.iconsdb.com/icons/preview/orange/airplane-3-xl.png" :
                     flightType === 'iranian' ? "https://www.iconsdb.com/icons/preview/green/airplane-3-xl.png" :
                     flightType === 'military' ? "https://www.iconsdb.com/icons/preview/red/airplane-3-xl.png" :
                     "https://img.icons8.com/external-soft-fill-juicy-fish/60/external-airplane-internet-of-things-soft-fill-soft-fill-juicy-fish.png",
                width: iconSize,
                height: iconSize,
                angle: flight.track || flight.heading || 0
              },
              attributes: flight,
              popupTemplate: {
                title: flightType === 'drone' ? "ğŸš Ù¾Ù‡Ù¾Ø§Ø¯ - TAR" :
                       flightType === 'unknown' ? "â“ Ø´ÛŒØ¡ Ù†Ø§Ø´Ù†Ø§Ø³" :
                       flightType === 'fighter' ? "âš”ï¸ Ø¬Ù†Ú¯Ù†Ø¯Ù‡ Ù†Ø¸Ø§Ù…ÛŒ" :
                       flightType === 'navy' ? "ğŸš¢ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ Ù†ÛŒØ±ÙˆÛŒ Ø¯Ø±ÛŒØ§ÛŒÛŒ" :
                       flightType === 'iranian' ? "ğŸ‡®ğŸ‡· Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ" :
                       flightType === 'military' ? "ğŸ–ï¸ Ù¾Ø±ÙˆØ§Ø² Ù†Ø¸Ø§Ù…ÛŒ" : "âœˆï¸ Ù¾Ø±ÙˆØ§Ø² ØºÛŒØ±Ù†Ø¸Ø§Ù…ÛŒ",
                content: flightType === 'drone' ? createDronePopupContent(flight) :
                         (flightType === 'military' || flightType === 'fighter' || flightType === 'navy' || flightType === 'iranian') ? createMilitaryPopupContent(flight) :
                         createCivilianPopupContent(flight)
              }
            });
            layer.add(graphic);
          }
        });

        updateStats();

        if (isFirstLoad && allFlights.length > 0) {
          const bounds = allFlights.filter(f => f.lat && f.lon).map(f => [f.lat, f.lon]);
          if (bounds.length > 0) {
            view.goTo({ target: bounds });
            isFirstLoad = false;
          }
        }
      }

      view.watch("zoom", () => {
        const iconSize = getIconSize(view.zoom);
        [civilianLayer, militaryLayer, droneLayer].forEach(layer => {
          layer.graphics.forEach(graphic => {
            graphic.symbol.width = iconSize;
            graphic.symbol.height = iconSize;
          });
        });
      });

      // Initialize
      updateMarkers();
      setInterval(updateMarkers, 15000);
      
      // Initial system message
      setTimeout(() => {
        addAlert('Ø³Ø§Ù…Ø§Ù†Ù‡ Ø±ØµØ¯ Ù¾Ù‡Ù¾Ø§Ø¯ÛŒ ØªØ§Ø± Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø± Ø§Ø³Øª');
      }, 1000);
    });
  </script>
</body>
</html>